// (c) 2012-2014 David Kemp
// animated-qubits may be freely distributed under the MIT license.

(function(e){"use strict";function t(t,n,r,i){function o(){t=t||e.Q,n=n||e.d3,i=i||e.d3Transform||n.transform||n.svg.transform,r=r||e.d3MeasureText,s=i().translate(function(e){return[e.x,e.y]}).scale(function(e){return e.amplitude.magnitude()}).rotate(function(e){return-180*e.amplitude.phase()/Math.PI})}function u(e){return o(),a(n.select(e))}function a(e){function u(e,t){var n=t.length,r=t.lineClass,i=t.headClass;e.append("line").attr("class",r).attr("x1",0).attr("y1",0).attr("x2",n).attr("y2",0);var s=n/4,o=n-s,u=-s/2,a=o,f=u+s,l=n,c=0;e.append("polygon").attr("class",i).attr("points",""+o+","+u+" "+a+","+f+" "+l+","+c)}function f(e,t,n){var r=e.enter().append("g").attr("class","animatedQubitsAmplitudeDisc").attr("transform",s);r.append("circle").attr("class","animatedQubitsAmplitudeCircle").attr("cx",0).attr("cy",0).attr("r",n.maxRadius),u(r,{length:n.maxRadius,lineClass:"animatedQubitsPhaseArrow",headClass:"animatedQubitsPhaseArrowEnd"})}function l(e,n,r,i){var o=[],u=[];return e.transition().duration(i.duration==null?1e3:i.duration).attr("transform",s).each(function(){var e=t.defer();o.push(e),u.push(e.promise)}).each("end",function(){o.pop().resolve()}),t.all(u)}r.d3=r.d3||n;var o=r("M");return{getTextHeight:function(){return o.height},getTextWidth:function(){return o.width*1.5},setHeight:function(t){e.attr("height",t)},setWidth:function(t){e.attr("width",t)},addText:function(t){var n=t.cssClass,r=t.x||0,i=t.y||0,s=t.text,u=t.subscript,a=e.append("text").attr("x",r);n&&a.attr("class",n),u?(a.append("tspan").text(s).attr("y",i),a.append("tspan").text(u).attr("class","animatedTextSubscript").attr("y",i+o.height/2)):a.text(s).attr("y",i)},createGroup:function(t){var n=t.cssClass,r=t.x||0,s=t.y||0,o=i().translate([r,s]),u=e.append("g").attr("class",n).attr("transform",o);return a(u)},renderAmplitudeDiscs:function(t,n,r){r=r||{};var i=e.selectAll(".animatedQubitsAmplitudeDisc").data(t,function(e){return e.key}),s=l(i,t,n,r);return f(i,t,n),i.exit().remove(),s}}}var s;return u}typeof define!="undefined"&&define.amd?define("qubitsGraphics",["q","d3","d3MeasureText"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("q"),require("d3"),require("d3-measure-text"),require("d3-transform")):(e.animatedQubitsInternal=e.animatedQubitsInternal||{},e.animatedQubitsInternal.graphicsFactory=t())})(this),function(e){"use strict";function t(t,n){function r(){t=t||e._,n=n||e.jsqubits}function i(e){function o(e){return i*(e*Math.SQRT2+1)}function u(e,r){var i=t.clone(e);return i.key=e.key+"-"+r,r>1&&(i.amplitude=n.ZERO),i}function a(e,n){var r=t.clone(n);return r.amplitude=e.amplitude,r}function f(n,r,s){var u=t.clone(n),a=r.asNumber();u.amplitude=n.amplitude.multiply(r.amplitude),u.bitString=r.asBitString(),u.numericIndex=a;var f=s[a];if(!f)f=s[a]=[],u.x=2*i,u.y=o(a);else{var l=t.last(f),c=l.amplitude;u.x=l.x+c.real()*e.maxRadius,u.y=l.y-c.imaginary()*e.maxRadius}return f.push(u),u}function l(e){return Object.keys(e).map(function(n){return e[n].map(function(t){return t.key})})}function c(r,i){function o(e){return e.reduce(function(t,n){return t.add(r.phase2b[n].amplitude)},n.ZERO)}function u(e){var n=o(e),i=t.clone(r.phase2b[e[0]]);return i.amplitude=n.magnitude()>1e-4?n:i.amplitude.multiply(s),r.phase3.push(i),i}function a(n,i){var o=n.amplitude,u=n.x+o.real()*e.maxRadius,a=n.y-o.imaginary()*e.maxRadius;for(var f=1;f<i.length;f++){var l=i[f],c=t.clone(r.phase2b[l]);c.amplitude=c.amplitude.multiply(s),c.x=u,c.y=a,r.phase3.push(c)}}i.forEach(function(e){var t=u(e);a(t,e)})}function h(e,t,r,i){return e.forEach(function(e){var s=t(n(e.bitString)),o=[];r.stateComponentIndexesGroupedBySource.push(o);var l=1;s.each(function(t){var n=u(e,l++),s=a(e,n),c=n.key;o.push(r.phase1.length),r.phase1.push(n),r.phase2a[c]=s,r.phase2b[c]=f(s,t,i)})}),r}function p(e){e.phase4=e.phase3.filter(function(t){return t.amplitude.magnitude()>1e-4})}function d(e){e.phase5=e.phase4.map(function(n){var r=t.clone(n);return r.x=0,r})}function v(e,t){var n=null;return e.some(function(r){if(r.numericIndex===t)return n=r,!0}),n}r();var i=e.maxRadius,s=n.complex(1e-4);return{yOffSetForState:o,augmentState:function(e){var t=0,n=[];return e.each(function(e){var r={bitString:e.asBitString(),numericIndex:e.asNumber(),amplitude:e.amplitude,key:"k"+ ++t,x:0,y:o(e.asNumber())};n.push(r)}),n.sort(function(e,t){return e.numericIndex-t.numericIndex}),n},createPhases:function(e,t){var n={phase1:[],phase2a:{},phase2b:{},stateComponentIndexesGroupedBySource:[],phase3:[]},r={};return h(e,t,n,r),c(n,l(r)),p(n),d(n),n},createIntermediateState:function(e,n){var r=t.clone(e);return r.forEach(function(t){var r=v(n,t.numericIndex);r&&r.amplitude.magnitude()>0?t.amplitude=r.amplitude:t.amplitude=t.amplitude.multiply(s)}),r}}}return i}typeof define!="undefined"&&define.amd?define("qubitAnimationCalculator",["lodash","jsqubits"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("lodash"),require("jsqubits").jsqubits):(e.animatedQubitsInternal=e.animatedQubitsInternal||{},e.animatedQubitsInternal.calculatorFactory=t())}(this),function(e){"use strict";function t(t,n){function r(){t=t||e.animatedQubitsInternal.graphicsFactory,n=n||e.animatedQubitsInternal.calculatorFactory}function i(e){function h(){return s.yOffSetForState(a-1)+o}function p(){return(1+u)*l+4*o}function d(e){return("0000000000000000"+e.toString(2)).slice(-u)}function v(e,t){var n=d(e);for(var r=0;r<u;r++)t.addText({cssClass:"animatedQubitsStateBitLabel",x:r*l,text:n.charAt(r)})}r();var i=t(e.element),s=n(e),o=e.maxRadius,u=e.numBits,a=1<<u,f=i.getTextHeight(),l=i.getTextWidth(),c;return{getNaturalDimensions:function(){return{height:h(),width:p()}},renderBitLabels:function(){var e=i.createGroup({cssClass:"animatedQubitsBitLabels",y:2*f/3});for(var t=0;t<u;t++){var n=(u-t-1).toString(),r=t*l;e.addText({text:"q",subscript:n,x:r})}},renderStateLabels:function(){for(var e=0;e<a;e++)v(e,i.createGroup({cssClass:"animatedQubitsStateLabel",y:s.yOffSetForState(e)+f/3}))},renderState:function(t,n){return c=c||i.createGroup({cssClass:"animatedQubitsAmplitudeDiscs",x:o+(u+1)*l}),c.renderAmplitudeDiscs(t,e,n)}}}return i}typeof define!="undefined"&&define.amd?define("animatedQubitsRenderer",["qubitsGraphics","qubitAnimationCalculator"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("./qubitsGraphics"),require("./qubitAnimationCalculator")):(e.animatedQubitsInternal=e.animatedQubitsInternal||{},e.animatedQubitsInternal.rendererFactory=t())}(this),function(e){"use strict";function t(t,n,r,i){function s(){t=t||e._,n=n||e.Q,r=r||e.animatedQubitsInternal.rendererFactory,i=i||e.animatedQubitsInternal.calculatorFactory}return function(o,u){function p(e){return l.renderState(e,{duration:0})}function d(e,t){return function(){var r=n.when();return e.stateComponentIndexesGroupedBySource.forEach(function(n){r=r.then(v(e,t,n)).then(m(e,t,n))}),r}}function v(e,t,n){return function(){return n.forEach(function(n){var r=t[n].key;t[n]=e.phase2a[r]}),l.renderState(t,{duration:0})}}function m(e,t,n){return function(){return n.forEach(function(n){var r=t[n].key;t[n]=e.phase2b[r]}),l.renderState(t)}}function g(e,t){return l.renderState.bind(null,e,t)}function y(e,n){var r=c.createPhases(a,e),i=r.phase1.map(t.clone),s=e(o),u;return o=s,a=c.augmentState(o),n&&n.skipInterferenceSteps?u=p(i).then(g(r.phase5)).then(g(a,{duration:0})):u=p(i).then(d(r,i)).then(g(r.phase3)).then(g(r.phase4,{duration:0})).then(g(r.phase5)).then(g(a,{duration:0})),u.then(function(){return s})}function b(e){var t,n;return o=o.measure(e).newState,n=c.augmentState(o),t=c.createIntermediateState(a,n),a=n,l.renderState(t).then(function(){return l.renderState(n,{duration:0})}).then(function(){return o})}s();var a,f=o.numBits(),l,c=i(u),h=n.when();return{display:function(e){l=r({element:e,numBits:f,maxRadius:u.maxRadius}),l.renderBitLabels(),l.renderStateLabels(),a=c.augmentState(o),l.renderState(a)},getNaturalDimensions:function(){if(!l)throw"Sorry, you must call display() before calling getNaturalDimensions()";return l.getNaturalDimensions()},applyOperation:function(e,t){return h=h.then(function(){return y(e,t)}),h},measure:function(e){return h=h.then(function(){return b(e)}),h}}}}typeof define!="undefined"&&define.amd?define("animatedQubits",["lodash","q","animatedQubitsRenderer","qubitAnimationCalculator"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("lodash"),require("q"),require("./lib/animatedQubitsRenderer"),require("./lib/qubitAnimationCalculator")):e.animatedQubits=t()}(this);